<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tax Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" type="image/png" href="./favicon.png" />
  <style>
    :root{
      --ink:#1a1d1f;
      --muted:#5c6670;
      --line:#e6e8eb;
      --soft:#f5f7f9;
      --brand:#0e8df1;
      --accent:#f7f0d9;               /* header band bg */
      --accent-ink:#121212;
      --success:#0a9150;
      --danger:#b3261e;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font:14px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif;
      color:var(--ink);
      background:#fafafa;
    }

    /* Page container */
    .page{
      max-width:1000px;
      margin:24px auto;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      box-shadow:0 4px 24px rgba(0,0,0,.06);
      overflow:hidden;
    }

    /* Header band */
    .header{
      display:flex;
      gap:16px;
      padding:20px 20px 16px;
      align-items:center;
      border-bottom:1px solid var(--line);
      background:linear-gradient(0deg,#fff, #fff), var(--accent);
      background-blend-mode:normal, multiply;
    }
    .brand{display:flex;align-items:center;gap:16px;flex:1}
    .brand img{height:40px;width:auto;display:block}
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      font-size:11px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      color:var(--muted);
    }

    /* Meta rows */
    .meta{
      display:grid;
      grid-template-columns:1.3fr .7fr 1fr;
      gap:16px;
      padding:16px 20px 8px;
      border-bottom:1px solid var(--line);
    }
    .card{
      border:1px solid var(--line);
      border-radius:10px;
      padding:12px 14px;
      background:#fff;
    }
    .card h4{
      margin:0 0 8px;
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.4px;
    }
    .card p{margin:0;font-size:13px}
    .card p + p{margin-top:4px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .kv{display:flex;justify-content:space-between;gap:12px}
    .kv span:last-child{font-weight:600}

    /* Order header strip */
    .strip{
      background:#fff3cd;            /* soft yellow */
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:10px 20px;
      display:flex;
      gap:20px;
      align-items:center;
      flex-wrap:wrap;
    }
    .strip strong{color:#111}
    .strip .muted{color:var(--muted)}

    /* Table */
    table{width:100%;border-collapse:collapse}
    .tbl{
      margin:16px 20px;
      border:1px solid var(--line);
      border-radius:10px;
      overflow:hidden;
    }
    .tbl th, .tbl td{
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:13px;
      word-break:break-word;
    }
    .tbl thead th{
      background:var(--soft);
      text-align:left;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.3px;
      color:#333;
    }
    .tbl tbody tr:nth-child(even){background:#fcfcfd}
    .tbl tfoot td{
      background:#fbfbfb;
      font-weight:600;
    }
    .num{text-align:right}
    .center{text-align:center}

    /* Totals */
    .totals{
      margin:0 20px 16px;
      display:grid;
      grid-template-columns:1fr 360px;
      gap:16px;
      align-items:start;
    }
    .panel{
      border:1px solid var(--line);
      border-radius:10px;
      padding:12px 14px;
      background:#fff;
    }
    .panel h4{margin:0 0 8px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
    .summary .row{display:flex;justify-content:space-between;padding:6px 0}
    .summary .row + .row{border-top:1px dashed var(--line)}
    .summary .grand{font-weight:700;font-size:15px}

    /* Terms */
    .terms{margin:0 20px 20px}
    .terms h4{margin:0 0 8px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
    .terms ul{margin:6px 0 0 16px;padding:0}
    .terms li{margin:6px 0;color:#2b2f33}

    /* Footer actions */
    .actions{
      padding:12px 20px 20px;
      display:flex;
      justify-content:center;
      gap:10px;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    .btn.primary{
      background:var(--brand);
      border-color:var(--brand);
      color:#fff;
    }

    /* Print */
    @media print{
      body{background:#fff}
      .page{box-shadow:none;border:none;margin:0;border-radius:0}
      .actions{display:none}
      .strip{page-break-inside:avoid}
      .tbl{margin:12px 0}
      .totals{margin:0 0 12px;grid-template-columns:1fr 300px}
      .terms{margin:0}
    }

    /* Small screens */
    @media (max-width: 1024px){
      .page{margin:0;border-radius:0}
      .meta{grid-template-columns:1fr;gap:12px}
      .totals{grid-template-columns:1fr;gap:12px}
    }

/* Make table scrollable on small screens */
.tbl-wrap{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}

/* Ensure a sensible min width so columns donâ€™t collapse */
.tbl table{ min-width: 980px; }

/* Slightly reduce min width on medium screens */
@media (max-width: 768px){
  .tbl table{ min-width: 840px; }
}

/* On very small screens, let it scroll as-needed */
@media (max-width: 480px){
  .tbl table{ min-width: 760px; }
}

/* Print: always full width, no scrolling container */
@media print{
  .tbl-wrap{ overflow: visible; }
  .tbl table{ min-width: 100%; }
}


  </style>
</head>
<body>
  <section class="page" id="invoice">

    <!-- Branded header -->
    <header class="header">
      <div class="brand">
        <img src="/images/logo.jpg" alt="Company Logo" />
        <div>
          <h1>Tax Invoice</h1>
          <span class="badge">GST: 07BCDPM7179L1Z0</span>
        </div>
      </div>
    </header>

    <!-- Meta cards: Bill/Ship, Invoice meta, Sold By -->
    <div class="meta">
      <div class="card">
        <h4>Bill to / Ship to</h4>
        <p><strong><%=result[0].firmname.toUpperCase()%></strong></p>
        <p><%=result[0].address%></p>
        <p>Phone:
          <a href="tel:+91<%=result[0].usernumber%>" class="mono">+91 <%=result[0].usernumber%></a>
        </p>
      </div>

      <div class="card">
        <h4>Invoice details</h4>
        <p class="kv"><span>Invoice No.</span> <span class="mono" id="invoiceNumber"></span></p>
        <p class="kv"><span>Invoice Date</span> <span class="mono"><%=result[0].created_at%></span></p>
        <p class="kv"><span>CIN</span> <span class="mono">U52100DL2016PTC292777</span></p>
      </div>

      <div class="card">
        <h4>Sold by</h4>
        <p><strong>E GADGET WORLD</strong></p>
        <p>1st Floor, J.K Tower, Kaushik Enclave Main Rd,<br/>
           Near Burari Hospital, Kaushik Enclave, Shankarpura,<br/>
           Burari, Delhi, 110084</p>
      </div>
    </div>

    <!-- Order strip -->
    <div class="strip">
      <div><strong>Order ID:</strong> <span class="mono"><%=result[0].orderid%></span></div>
      <div class="muted">Delivery estimate: <strong id="dateIn15Days"></strong></div>
      <div class="muted">Payment mode: <strong>Online</strong></div>
    </div>

    <!-- Items table -->
   <div class="tbl">
  <div class="tbl-wrap">
    <table>
        <thead>
          <tr>
            <th class="center" style="width:48px">#</th>
            <th style="width:210px">Item name</th>
            <th style="width:140px">SKU No.</th>
            <th class="center" style="width:70px">Qty</th>
            <th class="num" style="width:110px">MRP</th>
            <th class="num" style="width:120px">Unit Price</th>
            <th class="num" style="width:130px">Liquidation Value</th>
            <th class="num" style="width:110px">Tax Amount</th>
            <th class="center" style="width:80px">Tax %</th>
            <th class="num" style="width:110px">CGST</th>
            <th class="num" style="width:110px">SGST</th>
            <th class="num" style="width:110px">IGST</th>
            <th class="num" style="width:130px">Total Value</th>
          </tr>
        </thead>
        <tbody>
  <%
    const GST_PERC = 18;
    const sellerGSTIN = '07BCDPM7179L1Z0';                 // from header badge
    const sellerState = sellerGSTIN ? sellerGSTIN.slice(0,2) : '07';
    const buyerGSTIN  = (result[0].gstnumber || '').trim();
    const buyerState  = buyerGSTIN ? buyerGSTIN.slice(0,2) : null;
    const intraState  = buyerState && buyerState === sellerState;

    let grand_total = 0;
  %>

  <% for (let i = 0; i < result.length; i++) { 
       const qty = Number(result[i].quantity || 0);
       const unitPriceInc = Number(result[i].unitprice || 0);           // tax-inclusive per unit selling price
       const marginPerUnitInc = Number(result[i].product_margin_price || 0); // tax-inclusive per unit margin (only for margintax)
       const taxType = (result[i].tax_type || '').toLowerCase();        // 'gsttax' | 'margintax'

       // Totals for the line (quantity applied)
       let base_total = 0;      // taxable base (exclusive) for the line
       let gst_total = 0;       // total GST for the line
       let cgst_total = 0;
       let sgst_total = 0;
       let igst_total = 0;

       const total_inc = unitPriceInc * qty;  // line total inclusive (always)

       if (taxType === 'margintax') {
         // GST applies ONLY on the margin amount, which is already inclusive
         const margin_total_inc = marginPerUnitInc * qty;
         const margin_base_total = margin_total_inc / (1 + GST_PERC/100);
         gst_total = margin_total_inc - margin_base_total;

         // Base (exclusive) we show is the line total excl. GST portion on margin
         base_total = total_inc - gst_total;

       } else {
         // Default: gsttax (18% on full price, which is inclusive)
         base_total = total_inc / (1 + GST_PERC/100);
         gst_total  = total_inc - base_total;
       }

       if (intraState) {
         cgst_total = gst_total / 2;
         sgst_total = gst_total / 2;
         igst_total = 0;
       } else {
         cgst_total = 0;
         sgst_total = 0;
         igst_total = gst_total;
       }

       // For the table columns that look per-unit in your design:
       // - "MRP": show exclusive per-unit (best reference for price before tax seen by buyer)
       // - "Unit Price": show exclusive line amount (exclusive Ã— qty) for clarity
       // - "Liquidation Value": show margin TOTAL (incl.) if margin scheme; otherwise 0
       const perUnit_excl = base_total / Math.max(qty,1); // avoid /0
       const liquidation_total_inc = (taxType === 'margintax') ? (marginPerUnitInc * qty) : 0;

       grand_total += total_inc;
  %>
    <tr>
      <td class="center"><%= i+1 %></td>
      <td><%= result[i].productname %></td>
      <td class="mono"><%= result[i].skuno %></td>
      <td class="center"><%= qty %></td>

      <!-- MRP (exclusive, per unit) -->
      <td class="num"><%= perUnit_excl.toFixed(2) %></td>

      <!-- Unit Price (exclusive Ã— qty) -->
      <td class="num"><%= base_total.toFixed(2) %></td>

      <!-- Liquidation Value (margin, inclusive, line total) -->
      <td class="num"><%= liquidation_total_inc.toFixed(2) %></td>

      <!-- Tax Amount (line total GST) -->
      <td class="num"><%= gst_total.toFixed(2) %></td>

      <td class="center">18%</td>

      <td class="num"><%= cgst_total.toFixed(2) %></td>
      <td class="num"><%= sgst_total.toFixed(2) %></td>
      <td class="num"><%= igst_total.toFixed(2) %></td>

      <!-- Total Value (inclusive, line total) -->
      <td class="num"><%= total_inc.toFixed(2) %></td>
    </tr>
  <% } %>
</tbody>

</table>
  </div>
</div>


    <!-- Totals & Notes -->
    <div class="totals">
      <div class="panel">
        <h4>Notes</h4>
        <p class="muted">This is a computer generated invoice and does not require a signature.</p>
      </div>

      <div class="panel summary">
        <h4>Order summary</h4>
        <div class="row">
          <span>Total Order Value</span>
          <span class="mono">â‚¹ <%= grand_total.toFixed(2) %></span>
        </div>
      </div>
    </div>

    <!-- Terms -->
    <div class="terms panel">
      <h4>Terms & Conditions</h4>
      <ul>
        <li>Value of supply is determined in accordance with Section 15(5) of the CGST Act read with Rule 32(5). Pre-owned/Used items bought through this invoice fall under the Margin Scheme in GST as per Rule 32(5) of the CGST Rules, 2017 and <strong>no GST input</strong> shall be availed.</li>
        <li>Goods once sold cannot be returned. The buyer assumes all responsibility once goods are taken out of the sellerâ€™s premises by the buyer or their representative.</li>
        <li>Buyer agrees to save and hold the seller harmless from any claims, demands, liabilities, costs, expenses or judgment arising directly or indirectly involving the goods supplied by the seller.</li>
      </ul>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn" id="downloadInvoice">Print / Save as PDF</button>
      <button class="btn primary" onclick="window.print()">Quick Print</button>
    </div>
  </section>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <script>
    // Print button (fallback to window.print for consistency)
    document.getElementById('downloadInvoice').addEventListener('click', () => {
      window.print();
      // If you want strict PDF via html2pdf, uncomment below:
      // const node = document.getElementById('invoice');
      // html2pdf().set({
      //   margin: 0.5,
      //   filename: 'invoice.pdf',
      //   image: { type: 'jpeg', quality: 0.98 },
      //   html2canvas: { scale: 2, useCORS: true },
      //   jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      // }).from(node).save();
    });

    // Delivery estimate (+15 days)
    (function(){
      const today = new Date();
      const d = new Date(today);
      d.setDate(d.getDate() + 15);
      const formatted = d.toISOString().split('T')[0];
      document.getElementById('dateIn15Days').textContent = formatted;
    })();

    // Invoice number generator (prefix + last 7 of timestamp)
    (function(){
      const uniquePart = Date.now().toString().slice(-7);
      const number = 'INV' + uniquePart;
      document.getElementById('invoiceNumber').textContent = number;
    })();
  </script>
</body>
</html>
